<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Recuperar Contrase√±a - Secreto Helader√≠a</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #ff4757 0%,
          #ffeaa7 50%,
          #ffffff 100%
        );
        min-height: 100vh;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .recovery-container {
        max-width: 450px;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 25px;
        box-shadow: 0 15px 40px rgba(255, 71, 87, 0.2);
        padding: 50px 40px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .recovery-icon {
        font-size: 3.5em;
        margin-bottom: 15px;
        opacity: 0.8;
      }

      h1 {
        color: #ff4757;
        font-size: 2em;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(255, 71, 87, 0.3);
        margin-bottom: 15px;
        font-family: 'Georgia', serif;
      }

      .subtitle {
        color: #636e72;
        font-size: 1em;
        margin-bottom: 25px;
        line-height: 1.5;
      }

      /* Timer */
      .timer-container {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background: rgba(255, 234, 167, 0.3);
        border-radius: 15px;
        border: 2px solid rgba(255, 234, 167, 0.5);
        display: none;
      }

      .timer {
        font-size: 2.5em;
        font-weight: bold;
        color: #ff4757;
        margin-bottom: 5px;
      }

      .timer.warning {
        color: #ff9800;
      }

      .timer.danger {
        color: #e74c3c;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
      }

      .timer-text {
        color: #636e72;
        font-size: 0.9em;
      }

      /* Form groups */
      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        color: #2d3436;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 0.95em;
      }

      input[type="email"],
      input[type="password"] {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid #ffeaa7;
        border-radius: 15px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
        outline: none;
      }

      input[type="email"]:focus,
      input[type="password"]:focus {
        border-color: #ff4757;
        box-shadow: 0 0 0 4px rgba(255, 71, 87, 0.1);
        background: rgba(255, 255, 255, 1);
        transform: translateY(-1px);
      }

      /* C√≥digo de 4 d√≠gitos */
      .code-inputs {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
      }

      .code-digit {
        width: 60px;
        height: 70px;
        text-align: center;
        font-size: 28px;
        font-weight: bold;
        border: 3px solid #ffeaa7;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
        outline: none;
      }

      .code-digit:focus {
        border-color: #ff4757;
        box-shadow: 0 0 0 4px rgba(255, 71, 87, 0.1);
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
      }

      .code-digit.filled {
        border-color: #00b894;
        background: rgba(0, 184, 148, 0.1);
      }

      /* Botones */
      .btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #ff4757, #ff3742);
        color: white;
        border: none;
        border-radius: 20px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.3);
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(255, 71, 87, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #636e72, #2d3436);
        box-shadow: 0 6px 20px rgba(99, 110, 114, 0.3);
      }

      .btn-secondary:hover:not(:disabled) {
        box-shadow: 0 10px 30px rgba(99, 110, 114, 0.4);
      }

      /* Links */
      .links {
        text-align: center;
      }

      .links a {
        color: #ff4757;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .links a:hover {
        color: #ff3742;
        text-decoration: underline;
      }

      /* Alertas */
      .alert {
        padding: 15px 20px;
        margin-bottom: 25px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
      }

      .alert-error {
        background: rgba(255, 71, 87, 0.1);
        border: 1px solid rgba(255, 71, 87, 0.3);
        color: #d63031;
      }

      .alert-success {
        background: rgba(0, 184, 148, 0.1);
        border: 1px solid rgba(0, 184, 148, 0.3);
        color: #00b894;
      }

      /* Info box */
      .info-box {
        background: rgba(255, 234, 167, 0.3);
        border: 1px solid rgba(255, 234, 167, 0.5);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        font-size: 14px;
        color: #636e72;
        line-height: 1.5;
      }

      /* Estados de formulario */
      .step {
        display: none;
      }

      .step.active {
        display: block;
      }

      @media (max-width: 480px) {
        .recovery-container {
          margin: 10px;
          padding: 40px 30px;
        }

        .code-digit {
          width: 50px;
          height: 60px;
          font-size: 24px;
        }

        .code-inputs {
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="recovery-container">
      <div class="header">
        <div class="recovery-icon">üîê</div>
        <h1>Recuperar Contrase√±a</h1>
        <p class="subtitle">
          Sistema seguro de recuperaci√≥n con c√≥digo de verificaci√≥n
        </p>
      </div>

      {% if messages %}
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
      {% endif %}

      <!-- Paso 1: Solicitar email -->
      <div class="step {% if not codigo_enviado and not codigo_valido %}active{% endif %}" id="step1">
        <div class="info-box">
          üìß Ingresa tu email y te enviaremos un c√≥digo de 4 d√≠gitos para verificar tu identidad.
        </div>

        <form method="post" id="emailForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="enviar_codigo">
          
          <div class="form-group">
            <label for="email">Correo electr√≥nico:</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="tu-email@ejemplo.com"
              value="{{ email|default:'' }}"
            />
          </div>

          <button type="submit" class="btn">Enviar C√≥digo</button>
        </form>
      </div>

      <!-- Paso 2: Verificar c√≥digo solamente -->
      <div class="step {% if codigo_enviado and not codigo_valido %}active{% endif %}" id="step2">
        <div class="timer-container" id="timerContainer">
          <div class="timer" id="timer">1:00</div>
          <div class="timer-text">Tiempo restante para el c√≥digo</div>
        </div>

        <div class="info-box">
          ‚úâÔ∏è <strong>C√≥digo enviado a tu email</strong><br>
          Revisa tu bandeja de entrada e ingresa el c√≥digo de 4 d√≠gitos.
        </div>

        <form method="post" id="verifyCodeForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="verificar_codigo">
          <input type="hidden" name="email" value="{{ email }}" id="hiddenEmail">

          <div class="form-group">
            <label>C√≥digo de verificaci√≥n (4 d√≠gitos):</label>
            <div class="code-inputs">
              <input type="text" class="code-digit" maxlength="1" data-index="0">
              <input type="text" class="code-digit" maxlength="1" data-index="1">
              <input type="text" class="code-digit" maxlength="1" data-index="2">
              <input type="text" class="code-digit" maxlength="1" data-index="3">
            </div>
            <input type="hidden" name="codigo" id="hiddenCode">
          </div>

          <button type="submit" class="btn" id="verifyBtn">
            Verificar C√≥digo
          </button>
          
          <button type="button" class="btn btn-secondary" id="resendBtn">
            Reenviar C√≥digo
          </button>
        </form>
      </div>

      <!-- Paso 3: Nueva contrase√±a (solo despu√©s de c√≥digo v√°lido) -->
      <div class="step {% if codigo_valido %}active{% endif %}" id="step3">
        <div class="info-box" style="background: rgba(0, 184, 148, 0.1); border-color: rgba(0, 184, 148, 0.3);">
          ‚úÖ <strong>C√≥digo verificado correctamente</strong><br>
          Ahora puedes establecer tu nueva contrase√±a.
        </div>

        <form method="post" id="passwordForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="cambiar_password">
          <input type="hidden" name="email" value="{{ email }}">
          <input type="hidden" name="codigo_verificado" value="true">

          <div class="form-group">
            <label for="password1">Nueva contrase√±a:</label>
            <input type="password" id="password1" name="password1" required>
          </div>

          <div class="form-group">
            <label for="password2">Confirmar nueva contrase√±a:</label>
            <input type="password" id="password2" name="password2" required>
          </div>

          <button type="submit" class="btn">
            Cambiar Contrase√±a
          </button>
        </form>
      </div>

      <div class="links">
        <a href="{% url 'login' %}">Volver al inicio de sesi√≥n</a>
      </div>
    </div>

    <script>
      // Timer countdown - CAMBIADO A 1 MINUTO
      let timeLeft = 60; // 1 minuto en segundos
      const timerElement = document.getElementById('timer');
      const timerContainer = document.getElementById('timerContainer');

      function updateTimer() {
        if (!timerContainer || timerContainer.style.display === 'none') return;

        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;

        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Cambiar color seg√∫n tiempo restante - ajustado para 1 minuto
        if (timeLeft <= 15) { // √∫ltimos 15 segundos
          timerElement.className = 'timer danger';
        } else if (timeLeft <= 30) { // √∫ltimos 30 segundos
          timerElement.className = 'timer warning';
        } else {
          timerElement.className = 'timer';
        }

        if (timeLeft <= 0) {
          Swal.fire({
            title: 'C√≥digo Expirado',
            text: 'El c√≥digo ha expirado. Solicita uno nuevo.',
            icon: 'warning',
            confirmButtonText: 'Solicitar Nuevo',
            confirmButtonColor: '#ff4757'
          }).then(() => {
            location.reload();
          });
          return;
        }

        timeLeft--;
      }

      // Mostrar timer si estamos en step2
      {% if codigo_enviado and not codigo_valido %}
      if (timerContainer) {
        timerContainer.style.display = 'block';
        setInterval(updateTimer, 1000);
      }
      {% endif %}

      // Manejo de inputs de c√≥digo
      const codeInputs = document.querySelectorAll('.code-digit');
      const hiddenCode = document.getElementById('hiddenCode');

      if (codeInputs.length > 0) {
        codeInputs.forEach((input, index) => {
          input.addEventListener('input', (e) => {
            const value = e.target.value;

            // Solo n√∫meros
            if (!/^\d*$/.test(value)) {
              e.target.value = '';
              return;
            }

            // Marcar como lleno
            if (value) {
              e.target.classList.add('filled');
              // Auto-avanzar al siguiente input
              if (index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
              }
            } else {
              e.target.classList.remove('filled');
            }

            // Actualizar c√≥digo oculto
            updateHiddenCode();
          });

          input.addEventListener('keydown', (e) => {
            // Backspace: ir al input anterior
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
              codeInputs[index - 1].focus();
            }
          });

          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = e.clipboardData.getData('text');
            const digits = paste.replace(/\D/g, '').slice(0, 4);

            digits.split('').forEach((digit, i) => {
              if (codeInputs[i]) {
                codeInputs[i].value = digit;
                codeInputs[i].classList.add('filled');
              }
            });

            updateHiddenCode();
          });
        });

        function updateHiddenCode() {
          const code = Array.from(codeInputs).map(input => input.value).join('');
          if (hiddenCode) {
            hiddenCode.value = code;
          }
        }
      }

      // Mostrar SweetAlert cuando c√≥digo es correcto
      {% if codigo_valido %}
      Swal.fire({
        title: '¬°C√≥digo Correcto!',
        text: 'C√≥digo verificado exitosamente. Ahora puedes cambiar tu contrase√±a.',
        icon: 'success',
        confirmButtonText: 'Continuar',
        confirmButtonColor: '#ff4757'
      });
      {% endif %}

      // Bot√≥n reenviar c√≥digo
      const resendBtn = document.getElementById('resendBtn');
      if (resendBtn) {
        resendBtn.addEventListener('click', () => {
          const email = document.getElementById('hiddenEmail')?.value;
          if (email) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.innerHTML = `
              {% csrf_token %}
              <input type="hidden" name="action" value="enviar_codigo">
              <input type="hidden" name="email" value="${email}">
            `;
            document.body.appendChild(form);
            form.submit();
          }
        });
      }

      // Validaci√≥n del formulario de c√≥digo
      const verifyCodeForm = document.getElementById('verifyCodeForm');
      if (verifyCodeForm) {
        verifyCodeForm.addEventListener('submit', (e) => {
          const code = hiddenCode?.value || '';

          if (code.length !== 4) {
            e.preventDefault();
            Swal.fire({
              title: 'C√≥digo Incompleto',
              text: 'Por favor ingresa el c√≥digo completo de 4 d√≠gitos.',
              icon: 'warning',
              confirmButtonColor: '#ff4757'
            });
            return;
          }
        });
      }

      // Validaci√≥n del formulario de contrase√±a
      const passwordForm = document.getElementById('passwordForm');
      if (passwordForm) {
        passwordForm.addEventListener('submit', (e) => {
          const password1 = document.getElementById('password1')?.value || '';
          const password2 = document.getElementById('password2')?.value || '';

          if (password1.length < 8) {
            e.preventDefault();
            Swal.fire({
              title: 'Contrase√±a muy corta',
              text: 'La contrase√±a debe tener al menos 8 caracteres.',
              icon: 'warning',
              confirmButtonColor: '#ff4757'
            });
            return;
          }

          if (password1 !== password2) {
            e.preventDefault();
            Swal.fire({
              title: 'Contrase√±as no coinciden',
              text: 'Las contrase√±as ingresadas no son iguales.',
              icon: 'error',
              confirmButtonColor: '#ff4757'
            });
            return;
          }
        });
      }
    </script>
  </body>
</html>
